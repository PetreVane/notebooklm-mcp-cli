# Notes API Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Enable programmatic creation and management of notes from chat responses in NotebookLM notebooks.

**Architecture:** Notes are saved AI chat responses that appear in a notebook's left panel. Implementation follows the existing mixin pattern (NotesMixin), with MCP tools exposing functionality. RPC discovery required first.

**Tech Stack:** Python 3.11+, httpx, FastMCP, pytest

---

## Background

In CLAUDE.md, Notes is listed under "Features NOT Yet Implemented":
> `- [ ] **Notes** - Save chat responses as notes`

**What are Notes in NotebookLM?**
- Notes are saved AI chat responses (answers) that users can pin for reference
- They appear in the notebook's left panel alongside sources
- Users can create notes by clicking "Save as note" on any AI response
- Notes can be viewed, edited, and deleted

---

## Phase 1: RPC Discovery (COMPLETED)

**Status:** RPCs discovered from reference project `.notebooklm-py-analysis/`

### RPC Constants (from reference project)

| RPC ID | Constant Name | Purpose |
|--------|---------------|---------|
| `CYK0Xb` | `RPC_CREATE_NOTE` | Create a new note |
| `cFji9` | `RPC_GET_NOTES_AND_MIND_MAPS` | List notes and mind maps |
| `cYAfTb` | `RPC_UPDATE_NOTE` | Update note content/title |
| `AH0mwd` | `RPC_DELETE_NOTE` | Delete a note |

### Parameter Structures

**CREATE_NOTE (CYK0Xb):**
```python
params = [notebook_id, "", [1], None, "New Note"]
# Returns: [[note_id, ...]]
```

**GET_NOTES_AND_MIND_MAPS (cFji9):**
```python
params = [notebook_id]
# Returns: [[note_items...], timestamp]
# Each note: [note_id, [note_id, content, metadata, None, title], status]
# Deleted notes have: [note_id, None, 2]
```

**UPDATE_NOTE (cYAfTb):**
```python
params = [
    notebook_id,
    note_id,
    [[[content, title, [], 0]]],
]
# Returns: null on success
```

**DELETE_NOTE (AH0mwd):**
```python
params = [notebook_id, None, [note_id]]
# Returns: null on success (soft-delete: clears content, keeps ID)
```

### Notes vs Mind Maps

Notes and mind maps share the same storage structure (`cFji9` returns both). Distinguish by:
- **Notes:** Plain text content
- **Mind Maps:** JSON with `"children":` or `"nodes":` keys

---

## Phase 2: Client Implementation

**File:** `src/notebooklm_tools/core/notes.py` (new file)

### Task 2.1: Create NotesMixin skeleton

```python
"""NotesMixin - Note management operations.

This mixin provides note-related operations:
- create_note: Save a chat response as a note
- list_notes: Get all notes in a notebook
- update_note: Edit a note's content
- delete_note: Remove a note permanently
- get_note: Get a single note's details
"""

from typing import Any
from .base import BaseClient


class NotesMixin(BaseClient):
    """Mixin for note management operations."""

    def create_note(
        self,
        notebook_id: str,
        content: str,
        title: str | None = None,
        conversation_id: str | None = None,
    ) -> dict | None:
        """Create a note from content or a chat response.

        Args:
            notebook_id: The notebook UUID
            content: The note content (AI response text)
            title: Optional title for the note
            conversation_id: Optional conversation ID if saving from chat

        Returns:
            Dict with note_id and metadata, or None on failure
        """
        pass

    def list_notes(self, notebook_id: str) -> list[dict]:
        """List all notes in a notebook.

        Args:
            notebook_id: The notebook UUID

        Returns:
            List of note dicts with id, title, content, created_at
        """
        pass

    def get_note(self, note_id: str) -> dict | None:
        """Get a single note's details.

        Args:
            note_id: The note UUID

        Returns:
            Dict with note details, or None if not found
        """
        pass

    def update_note(
        self,
        note_id: str,
        content: str | None = None,
        title: str | None = None,
    ) -> dict | None:
        """Update a note's content or title.

        Args:
            note_id: The note UUID
            content: New content (optional)
            title: New title (optional)

        Returns:
            Updated note dict, or None on failure
        """
        pass

    def delete_note(self, note_id: str) -> bool:
        """Delete a note permanently.

        Args:
            note_id: The note UUID

        Returns:
            True on success, False on failure
        """
        pass
```

### Task 2.2: Add RPC constants to base.py

**File:** `src/notebooklm_tools/core/base.py`

Add after line ~100 (after other RPC definitions):
```python
# Notes RPCs
RPC_CREATE_NOTE = "CYK0Xb"            # Create note from content
RPC_GET_NOTES = "cFji9"               # List notes and mind maps in notebook
RPC_UPDATE_NOTE = "cYAfTb"            # Update note content/title
RPC_DELETE_NOTE = "AH0mwd"            # Delete note permanently
```

**Note:** `CYK0Xb` is also used for `RPC_SAVE_MIND_MAP` (already exists). Both create note and save mind map use the same RPC with different parameters.

### Task 2.3: Implement create_note

Based on discovered RPC, implement the method with:
- Parameter construction matching captured format
- Response parsing for note_id extraction
- Error handling consistent with other methods

### Task 2.4: Implement list_notes

Parse notebook data or dedicated RPC response to extract notes array.

### Task 2.5: Implement get_note, update_note, delete_note

Complete remaining CRUD operations.

### Task 2.6: Add NotesMixin to client.py

**File:** `src/notebooklm_tools/core/client.py`

```python
from .notes import NotesMixin

class NotebookLMClient(ExportMixin, DownloadMixin, StudioMixin, ResearchMixin,
                       ConversationMixin, SourceMixin, SharingMixin, NotebookMixin,
                       NotesMixin):  # Add NotesMixin
```

---

## Phase 3: MCP Tools Implementation

**File:** `src/notebooklm_tools/mcp/tools/notes.py` (new file)

### Task 3.1: Create notes.py tool module

```python
"""Notes tools - Note management operations."""

from typing import Any
from ._utils import get_client, logged_tool


@logged_tool()
def note_create(
    notebook_id: str,
    content: str,
    title: str | None = None,
) -> dict[str, Any]:
    """Create a note in a notebook.

    Args:
        notebook_id: Notebook UUID
        content: Note content (text)
        title: Optional title for the note

    Returns: note_id, title, created_at
    """
    try:
        client = get_client()
        result = client.create_note(notebook_id, content, title)

        if result and result.get("id"):
            return {
                "status": "success",
                "note_id": result["id"],
                "title": result.get("title", ""),
                "created_at": result.get("created_at"),
            }
        return {"status": "error", "error": "Failed to create note"}
    except Exception as e:
        return {"status": "error", "error": str(e)}


@logged_tool()
def note_list(notebook_id: str) -> dict[str, Any]:
    """List all notes in a notebook.

    Args:
        notebook_id: Notebook UUID

    Returns: Array of notes with id, title, content preview
    """
    try:
        client = get_client()
        notes = client.list_notes(notebook_id)

        return {
            "status": "success",
            "notebook_id": notebook_id,
            "notes": notes,
            "count": len(notes),
        }
    except Exception as e:
        return {"status": "error", "error": str(e)}


@logged_tool()
def note_get(note_id: str) -> dict[str, Any]:
    """Get a note's full content.

    Args:
        note_id: Note UUID

    Returns: Full note with content
    """
    try:
        client = get_client()
        result = client.get_note(note_id)

        if result:
            return {
                "status": "success",
                "note": result,
            }
        return {"status": "error", "error": "Note not found"}
    except Exception as e:
        return {"status": "error", "error": str(e)}


@logged_tool()
def note_update(
    note_id: str,
    content: str | None = None,
    title: str | None = None,
) -> dict[str, Any]:
    """Update a note's content or title.

    Args:
        note_id: Note UUID
        content: New content (optional)
        title: New title (optional)

    Returns: Updated note details
    """
    if content is None and title is None:
        return {"status": "error", "error": "Must provide content or title to update"}

    try:
        client = get_client()
        result = client.update_note(note_id, content, title)

        if result:
            return {
                "status": "success",
                "note_id": note_id,
                "updated": True,
            }
        return {"status": "error", "error": "Failed to update note"}
    except Exception as e:
        return {"status": "error", "error": str(e)}


@logged_tool()
def note_delete(note_id: str, confirm: bool = False) -> dict[str, Any]:
    """Delete a note permanently. IRREVERSIBLE. Requires confirm=True.

    Args:
        note_id: Note UUID
        confirm: Must be True after user approval
    """
    if not confirm:
        return {
            "status": "error",
            "error": "Deletion not confirmed. Set confirm=True after user approval.",
            "warning": "This action is IRREVERSIBLE.",
        }

    try:
        client = get_client()
        result = client.delete_note(note_id)

        if result:
            return {
                "status": "success",
                "message": f"Note {note_id} has been permanently deleted.",
            }
        return {"status": "error", "error": "Failed to delete note"}
    except Exception as e:
        return {"status": "error", "error": str(e)}
```

### Task 3.2: Register notes tools in server.py

**File:** `src/notebooklm_tools/mcp/server.py`

Add to imports in `_register_tools()`:
```python
from .tools import (
    downloads,
    auth,
    notebooks,
    sources,
    sharing,
    research,
    studio,
    chat,
    exports,
    notes,  # Add this
)
```

### Task 3.3: Update MCP server instructions

**File:** `src/notebooklm_tools/mcp/server.py`

Update the `instructions` string in FastMCP initialization to include notes tools.

---

## Phase 4: Testing

### Task 4.1: Create unit tests for NotesMixin

**File:** `tests/core/test_notes.py` (new file)

```python
"""Tests for NotesMixin class."""

import pytest
from unittest.mock import patch, MagicMock


def test_notes_mixin_import():
    """Test that NotesMixin can be imported."""
    from notebooklm_tools.core.notes import NotesMixin
    assert NotesMixin is not None


def test_notes_mixin_inherits_base():
    """Test that NotesMixin inherits from BaseClient."""
    from notebooklm_tools.core.notes import NotesMixin
    from notebooklm_tools.core.base import BaseClient
    assert issubclass(NotesMixin, BaseClient)


def test_notes_mixin_has_methods():
    """Test that NotesMixin has all expected methods."""
    from notebooklm_tools.core.notes import NotesMixin

    expected_methods = [
        'create_note',
        'list_notes',
        'get_note',
        'update_note',
        'delete_note',
    ]

    for method_name in expected_methods:
        assert hasattr(NotesMixin, method_name), f"Missing method: {method_name}"


def test_create_note_calls_rpc():
    """Test that create_note calls the correct RPC."""
    from notebooklm_tools.core.notes import NotesMixin

    with patch.object(NotesMixin, '_refresh_auth_tokens'):
        with patch.object(NotesMixin, '_call_rpc') as mock_rpc:
            mock_rpc.return_value = [["note_id_123", "Note Title"]]

            mixin = NotesMixin(cookies={"test": "cookie"}, csrf_token="test")
            result = mixin.create_note("notebook_123", "Note content")

            mock_rpc.assert_called_once()


def test_delete_note_returns_bool():
    """Test that delete_note returns boolean."""
    from notebooklm_tools.core.notes import NotesMixin

    with patch.object(NotesMixin, '_refresh_auth_tokens'):
        with patch.object(NotesMixin, '_call_rpc') as mock_rpc:
            mock_rpc.return_value = []

            mixin = NotesMixin(cookies={"test": "cookie"}, csrf_token="test")
            result = mixin.delete_note("note_123")

            assert isinstance(result, bool)
```

### Task 4.2: Add MCP tool tests

Extend existing MCP test patterns for notes tools.

### Task 4.3: Add to MCP_TEST_PLAN.md

**File:** `docs/MCP_TEST_PLAN.md`

Add new test group:
```markdown
## Test Group N: Notes Management

### Test N.1 - Create Note
**Tool:** `note_create`

**Prompt:**
```
Create a note in notebook [notebook_id] with content "This is a test note".
```

**Expected:** Note created with `note_id`.

### Test N.2 - List Notes
**Tool:** `note_list`

**Prompt:**
```
List all notes in notebook [notebook_id].
```

**Expected:** Array of notes including the one just created.

### Test N.3 - Update Note
**Tool:** `note_update`

**Prompt:**
```
Update note [note_id] with new content "Updated content".
```

**Expected:** Success confirmation.

### Test N.4 - Delete Note
**Tool:** `note_delete`

**Prompt:**
```
Delete note [note_id] with confirm=True.
```

**Expected:** Deletion confirmation.
```

---

## Phase 5: Documentation Updates

### Task 5.1: Update CLAUDE.md

Remove Notes from "Features NOT Yet Implemented" and add to MCP Tools table:
```markdown
| `note_create` | Create a note in a notebook |
| `note_list` | List all notes in a notebook |
| `note_get` | Get a note's full content |
| `note_update` | Update a note's content or title |
| `note_delete` | Delete a note (REQUIRES confirmation) |
```

### Task 5.2: Update API_REFERENCE.md

Add Notes RPCs section with discovered parameter/response structures.

### Task 5.3: Run full test suite

```bash
uv run pytest tests/
```

Verify all tests pass.

---

## Verification

After implementation is complete:

1. **Unit tests:** `uv run pytest tests/core/test_notes.py -v`
2. **Full test suite:** `uv run pytest tests/ -v`
3. **MCP integration test:**
   - Restart MCP server: `uv cache clean && uv tool install --force .`
   - Use AI assistant to run notes tests from MCP_TEST_PLAN.md
4. **Manual verification:**
   - Create a note via MCP, verify it appears in NotebookLM UI
   - Edit/delete note via MCP, verify changes in UI

---

## Task Summary

| Phase | Tasks | Estimated Steps |
|-------|-------|-----------------|
| Phase 1: RPC Discovery | 5 | ~10 |
| Phase 2: Client Implementation | 6 | ~15 |
| Phase 3: MCP Tools | 3 | ~8 |
| Phase 4: Testing | 3 | ~10 |
| Phase 5: Documentation | 3 | ~5 |
| **Total** | **20** | **~48** |

---

## Progress Tracking

- [x] Phase 1: RPC Discovery (COMPLETED - from reference project)
  - [x] Task 1.1: CREATE_NOTE = "CYK0Xb"
  - [x] Task 1.2: GET_NOTES_AND_MIND_MAPS = "cFji9"
  - [x] Task 1.3: UPDATE_NOTE = "cYAfTb"
  - [x] Task 1.4: DELETE_NOTE = "AH0mwd"
  - [x] Task 1.5: Parameter structures documented

- [ ] Phase 2: Client Implementation
  - [ ] Task 2.1: Create NotesMixin skeleton
  - [ ] Task 2.2: Add RPC constants to base.py
  - [ ] Task 2.3: Implement create_note
  - [ ] Task 2.4: Implement list_notes
  - [ ] Task 2.5: Implement get_note, update_note, delete_note
  - [ ] Task 2.6: Add NotesMixin to client.py

- [ ] Phase 3: MCP Tools Implementation
  - [ ] Task 3.1: Create notes.py tool module
  - [ ] Task 3.2: Register notes tools in server.py
  - [ ] Task 3.3: Update MCP server instructions

- [ ] Phase 4: Testing
  - [ ] Task 4.1: Create unit tests for NotesMixin
  - [ ] Task 4.2: Add MCP tool tests
  - [ ] Task 4.3: Add to MCP_TEST_PLAN.md

- [ ] Phase 5: Documentation Updates
  - [ ] Task 5.1: Update CLAUDE.md
  - [ ] Task 5.2: Update API_REFERENCE.md
  - [ ] Task 5.3: Run full test suite
